{"version":3,"sources":["globals.js","event-emitter.js","app.js","profile.js","ajax-form.js","player.js","upvote-form.js","ajax-forms-initializer.js","player-initializer.js","upvote-forms-initializer.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/KA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"app.js","sourcesContent":["\"use strict\";\n\n/**\n * Globally exposed namespacing function.\n * @param {string} namespace\n */\nfunction namespace(namespace) {\n    var object = window, tokens = namespace.split(\".\"), token;\n\n    while (tokens.length > 0) {\n        token = tokens.shift();\n\n        if (typeof object[token] === \"undefined\") {\n            object[token] = {};\n        }\n\n        object = object[token];\n    }\n\n    return object;\n}\n\n/**\n * Globally exposed extending function.\n * @param {array} parent prototypes\n * @param {hash} children\n */\nfunction extend(target, source) {\n    target = target || {};\n    for (var prop in source) {\n        if (typeof source[prop] === 'object') {\n            target[prop] = extend(target[prop], source[prop]);\n        } else {\n            target[prop] = source[prop];\n        }\n    }\n    return target;\n}\n\nfunction inherit(parents, child, properties) {\n    var childPrototype = properties;\n\n    for (var i in parents) {\n        var parentPrototype = Object.create(parents[i].prototype);\n        childPrototype = extend(parentPrototype, childPrototype);\n    }\n\n    child.prototype = childPrototype;\n    child.prototype.constructor = child;\n\n    return child;\n}\n\n\n/**\n * Globally filters out jQuery elements matching selector\n * from the haystack\n * @param {*} selector\n * @param {*} haystack\n */\nfunction filter(selector, haystack) {\n    var matches = [],\n        i = -1;\n\n    while (++i < haystack.length) {\n        if (haystack[i].element && haystack[i].element.is(selector)) {\n            matches.push(haystack[i]);\n        }\n    }\n\n    return matches;\n}\n","(function (undefined) {\n\n    \"use strict\";\n\n    var EventEmitter = namespace(\"Tmt\").EventEmitter = function() {\n        this.events = null;\n    };\n\n    inherit([Evemit], namespace(\"Tmt\").EventEmitter, {\n        'initialize': function () {\n            // Exposing the creation in a prototype function\n            // ensures child classes will have an instantiated value\n            // even if they don't go through the constructor.\n            this.events = {};\n        }\n    });\n\n}());\n","(function (undefined) {\n\n    \"use strict\";\n\n    var App = namespace(\"Tmt\").App = function () {\n        this.profile = null;\n        this.initializers = [];\n\n        this.initialize();\n    };\n\n    inherit([Tmt.EventEmitter], App, {\n        boot: function () {\n            this.profile = new Tmt.Models.Profile();\n            prepareInitializers.call(this);\n            this.emit(\"ready\");\n        },\n\n        setData: function (data) {\n            if (data.profile) {\n                this.profile.setData(data.profile);\n            }\n        }\n    });\n\n    function prepareInitializers() {\n        // Create an intance of each initializer.\n        for (var type in Tmt.Initializers) {\n            this.initializers[type] = new Tmt.Initializers[type]();\n        }\n\n        // Run the initialization. This is done in two steps because\n        // initializers may depend on one another.\n        for (var type in this.initializers) {\n            this.initializers[type].build(this);\n        }\n    }\n\n}());\n","(function (undefined) {\n\n    \"use strict\";\n\n    var Profile = namespace(\"Tmt.Models\").Profile = function () {\n        this.initialize();\n    };\n\n    inherit([Tmt.EventEmitter], Profile, {\n\n        setData: function (userData) {\n            this.albumUpvotes = indexUpvotes(\"albumUpvotes\", userData);\n            this.trackUpvotes = indexUpvotes(\"trackUpvotes\", userData);\n\n            if (this.albumUpvotes && this.albumUpvotes.length > 0) {\n                this.emit(\"upvoteSet\", \"album\", this.albumUpvotes);\n            }\n\n            if (this.trackUpvotes && this.trackUpvotes.length > 0) {\n                this.emit(\"upvoteSet\", \"track\", this.trackUpvotes);\n            }\n        },\n\n        addUpvote: function (type, key, value) {\n            if (type == \"album\") {\n                return this.addAlbumUpvote(key, value);\n            } else if (type == \"track\") {\n                return this.addTrackUpvote(key, value);\n            }\n        },\n\n        addAlbumUpvote: function (key, value) {\n            this.albumUpvotes[key] = value;\n            this.emit(\"upvoteUpdate\", \"album\", this.albumUpvotes);\n        },\n\n        addTrackUpvote: function (key, value) {\n            this.trackUpvotes[key] = value;\n            this.emit(\"upvoteUpdate\", \"track\", this.trackUpvotes);\n        },\n\n        removeUpvote: function (type, key) {\n            if (type == \"album\") {\n                return this.removeAlbumUpvote(key, value);\n            } else if (type == \"track\") {\n                return this.removeTrackUpvote(key, value);\n            }\n        },\n\n        removeAlbumUpvote: function (type, key) {\n            delete this.albumUpvotes[key];\n            this.emit(\"upvoteUpdate\", \"album\", this.upvotes);\n        },\n\n        removeTrackUpvote: function (type, key) {\n            delete this.trackUpvotes[key];\n            this.emit(\"upvoteUpdate\", \"track\", this.upvotes);\n        }\n    });\n\n    function indexUpvotes(key, data) {\n        var indexed = [];\n        if (data && data[key]) {\n            for (var i in data[key]) {\n                var id = data[key][i].id,\n                    value = data[key][i].vote;\n\n                indexed[id] = value;\n            }\n        }\n        return indexed;\n    }\n\n}());\n","(function() {\n\n    \"use strict\";\n\n    /**\n     * A form object that can be captured using ajax.\n     * @param {jQuery} el\n     */\n    var AjaxForm = namespace(\"Tmt.Components\").AjaxForm = function(el) {\n        this.element = el;\n        this.initialize();\n    };\n\n    inherit([ Tmt.EventEmitter ], AjaxForm, {\n        render : function() {\n            this.addEvents();\n        },\n\n        addEvents : function() {\n            this.element.on(\"submit\", onSubmit.bind(this));\n            this.element.on(\"onBeforeSubmit\", onBeforeSubmit.bind(this));\n            this.emit(\"bound\", this);\n        }\n    });\n\n\n    function onSubmit(event) {\n        event.preventDefault();\n\n        this.emit(\"beforeSubmit\", this, event);\n\n        var formElement = this.element;\n\n        $.ajax({\n            url: formElement.attr(\"action\"),\n            data: new FormData(formElement.get(0)),\n            cache: false,\n            processData: false,\n            contentType: false,\n            type: formElement.attr('method'),\n            success: onSubmitSuccess.bind(this)\n        });\n\n        this.emit(\"submit\", this);\n    };\n\n    function onBeforeSubmit()\n    {\n        this.element.addClass(\"working\");\n    }\n\n    function onSubmitSuccess(response) {\n        /*\n        var newVersion = $(html);\n\n        this.element.replaceWith(newVersion);\n        this.element = newVersion;\n        this.addEvents();*/\n\n        this.emit(\"submitSuccess\", response, this);\n        // this.emit(\"afterRender\", this);\n    }\n\n}());\n","(function ($, undefined) {\n\n    \"use strict\";\n\n    var Player = namespace(\"Tmt.Components\").Player = function (element) {\n        this.element = element;\n        this.embed = null;\n        this.ytPlayer = null;\n        this.isPlaying = false;\n        this.range = null;\n\n        this.initialize();\n    };\n\n    inherit([Tmt.EventEmitter], Player, {\n\n        'render': function () {\n            this.hasVideoId() ?\n                embedVideo.call(this) :\n                queryForKey.call(this);\n        },\n\n        'getEmbedId': function () {\n            if (this.hasVideoId) {\n                return \"tmt_player_\" + this.getVideoId();\n            }\n        },\n\n        'getVideoId': function () {\n            return this.element.data(\"song-vid\");\n        },\n\n        'setVideoId': function (id) {\n            this.element.data(\"song-vid\", id);\n        },\n\n        'hasVideoId': function () {\n            return this.getVideoId() != \"\";\n        },\n\n        'getSongSlug': function () {\n            return this.element.data(\"song-slug\");\n        }\n    });\n\n    function queryForKey() {\n        $.getJSON('/ajax/ytkey/' + this.getSongSlug(), onYtKeyReceived.bind(this));\n    }\n\n    function onYtKeyReceived(response) {\n        if (response.youtubekey.length === 11) {\n            this.setVideoId(response.youtubekey);\n            embedVideo.call(this);\n        }\n    }\n\n    function embedVideo() {\n        var id = this.getEmbedId();\n        var iframeHtml =\n            '<iframe id=\"' + id + '\" scrolling=\"no\" marginwidth=\"0\" ' +\n            'marginheight=\"0\" frameborder=\"0\" src=\"//www.youtube.com/embed/' +\n            this.getVideoId() + '?enablejsapi=1&amp;iv_load_policy=3&amp;' +\n            'playerapiid=songplayer_component_17&amp;disablekb=1&amp;wmode=transparent&amp;controls=0' +\n            '&amp;playsinline=0&amp;showinfo=0&amp;modestbranding=1&amp;rel=0&amp;' +\n            'autoplay=0&amp;loop=0&amp;origin=' + window.location.origin + '\"></iframe>'\n\n        this.element.append(iframeHtml);\n        this.embed = $(\"#\" + id);\n\n        this.ytPlayer = new YT.Player(id);\n\n        this.ytPlayer.addEventListener('onReady', onPlayerReady.bind(this));\n        this.ytPlayer.addEventListener('onStateChange', onPlayerStateChange.bind(this));\n    }\n\n    function onPlayerStateChange(newState) {\n        /*\n        -1 (unstarted)\n        0 (ended)\n        1 (playing)\n        2 (paused)\n        3 (buffering)\n        5 (video queued) */\n        var controlButton = this.element.find('.play');\n\n        if (newState.data === 1) {\n            controlButton.removeClass(\"fa-play\");\n            controlButton.addClass(\"fa-pause\");\n\n            this.isPlaying = true;\n            onPlayerTick.call(this);\n        }\n        else if (newState.data === 2) {\n            controlButton.removeClass(\"fa-pause\");\n            controlButton.addClass(\"fa-play\");\n\n            this.isPlaying = false;\n        }\n    }\n\n    function onProgressClick(e) {\n        if (this.isPlaying) {\n            var progressBar = this.element.find(\".progress-wrap .progress\");\n            var offset = progressBar.offset();\n            var relX = e.pageX - offset.left;\n            var pctLocation = relX / progressBar.width();\n            player.seekTo(pctLocation * this.ytPlayer.getDuration(), true);\n        }\n    };\n\n    function onPlayBtnClick(e) {\n        // Ranges wil be back shortly\n        this.playingRange = null;\n\n        (this.ytPlayer.getPlayerState() != 1) ?\n            this.ytPlayer.playVideo() :\n            this.ytPlayer.pauseVideo();\n    }\n\n\n    function onPlayerReady(event) {\n        this.element.find(\".duration\").html(toReadableTime(this.ytPlayer.getDuration()));\n        this.element.find(\".position\").html(toReadableTime(0));\n        this.element.find(\".progress-wrap .progress\").click(onProgressClick.bind(this));\n\n        var playBtn = this.element.find('.play');\n        playBtn.removeClass(\"fa-stop\");\n        playBtn.addClass(\"fa-play\");\n        playBtn.click(onPlayBtnClick.bind(this));\n\n        // Ranges wil be back shortly\n        // $(\"*[data-from]\").click(function () {\n        //     var el = $(this);\n        //     tmt.playingRange = [parseInt(el.attr(\"data-from\"), 10), parseInt(el.attr(\"data-to\"), 10)];\n        //     (player.getPlayerState() != 1) ? player.playVideo() : player.pauseVideo();\n        //     player.seekTo(tmt.playingRange[0], true);\n        // });\n    };\n\n    function onPlayerTick() {\n        var currentTime = this.ytPlayer.getCurrentTime(),\n            durationTime = this.ytPlayer.getDuration(),\n            currentPositionPct = (currentTime / durationTime) * 100;\n\n        this.element.find('.position').html(toReadableTime(currentTime));\n\n        this.element.find('.cursor').css(\"left\", currentPositionPct + \"%\");\n        this.element.find('.progress .loaded-bar').css(\"width\", (this.ytPlayer.getVideoLoadedFraction() * 100) + \"%\");\n        this.element.find('.progress .playing-bar').css(\"width\", currentPositionPct + \"%\");\n        this.element.find('.progress .playing-bar').attr(\"aria-valuenow\", currentTime);\n\n        if (this.isPlaying) {\n            // if (tmt.playingRange) {\n\n            //     if (currentTime >= tmt.playingRange[1]) {\n            //         tmt.playingRange = null;\n            //         player.pauseVideo();\n            //     }\n            //     else if (currentTime <= tmt.playingRange[0]) {\n            //         player.seekTo(tmt.playingRange[0], true);\n            //     }\n            // }\n            setTimeout(onPlayerTick.bind(this), 250);\n        }\n    }\n\n    function toReadableTime(seconds) {\n        var time = new Date(1000 * seconds),\n            mins = (\"0\" + time.getMinutes()).slice(-2),\n            secs = (\"0\" + time.getSeconds()).slice(-2);\n\n        return mins + \":\" + secs;\n    }\n\n})(jQuery);\n","(function ($, undefined) {\n\n    \"use strict\";\n\n    var UpvoteForm = namespace(\"Tmt.Components\").UpvoteForm = function (ajaxForm) {\n        this.ajaxForm = ajaxForm;\n        this.element = ajaxForm.element;\n\n        this.initialize();\n    };\n\n    inherit([Tmt.EventEmitter], UpvoteForm, {\n\n        \"initialize\": function () {\n            Tmt.EventEmitter.prototype.initialize.call(this);\n            this.addEvents();\n        },\n\n        \"addEvents\": function () {\n            this.element.find(\"button\").click(onButtonClick.bind(this));\n            this.ajaxForm.on('submitSuccess', onSubmitSuccess.bind(this));\n        },\n\n        \"getType\": function () {\n            return this.element.data(\"upvote-type\");\n        },\n\n        \"getObjectId\": function () {\n            return this.element.data(\"upvote-object-id\");\n        },\n\n        \"isTrack\": function () {\n            return this.getType() == \"track\";\n        },\n\n        \"isAlbum\": function () {\n            return this.getType() == \"album\";\n        },\n\n        \"setValue\": function (value) {\n            this.element.removeClass(\"liked disliked\");\n            this.element.find(\"input[name=vote]\").val(value);\n\n            if (value == 1) {\n                this.element.addClass(\"liked\");\n            } else if (value == 2) {\n                this.element.addClass(\"disliked\");\n            }\n\n            this.emit('valueChange', value, this);\n        },\n\n        \"getValue\": function () {\n            return this.element.find(\"input[name=vote]\").val();\n        },\n\n        \"lock\": function () {\n            this.element.find(\"button\").attr(\"disabled\", \"disabled\");\n        },\n\n        \"unlock\": function () {\n            this.element.find(\"button\").removeAttr(\"disabled\");\n        }\n    });\n\n    function onButtonClick(evt) {\n        var clickedValue = evt.target.value;\n\n        if (clickedValue != this.getValue()) {\n            this.setValue(clickedValue);\n        } else {\n            // twice the same value means the user wants to cancel\n            this.setValue(-1);\n        }\n\n        this.lock();\n        this.element.submit();\n    }\n\n    function onSubmitSuccess(response, ajaxForm) {\n        if (response && response.vote) {\n            this.setValue(response.vote);\n        }\n\n        this.unlock();\n    }\n\n})(jQuery);\n","(function ($, undefined) {\n\n    \"use strict\";\n\n    /**\n     * Ajax-enabled forms public bootstraper\n     */\n    var AjaxFormsInitializer = namespace(\"Tmt.Initializers\").AjaxFormsInitializer = function () {\n        this.forms = [];\n        this.initialize();\n    };\n\n    inherit([Tmt.EventEmitter], AjaxFormsInitializer, {\n        'build': function (app) {\n            addEvents.call(this, app);\n        }\n    });\n\n    function bindPageForms() {\n        var forms = [];\n\n        $(\"form[data-ctrl-mode=ajax]\").each(function () {\n            var form = new Tmt.Components.AjaxForm($(this));\n            form.render();\n            forms.push(form);\n        });\n\n        this.forms = forms;\n        this.emit('bound', this);\n    }\n\n    function addEvents(app) {\n        app.on('ready', bindPageForms.bind(this));\n    }\n\n}(jQuery));\n","(function ($, undefined) {\n\n    \"use strict\";\n\n    var PlayerInitializer = namespace(\"Tmt.Initializers\").PlayerInitializer = function () {\n        this.initialize();\n        this.players = [];\n    };\n\n    inherit([Tmt.EventEmitter], PlayerInitializer, {\n        'build': function (app) {\n            addEvents.call(this, app);\n        }\n    });\n\n    function addEvents(app) {\n        $(onDomReady.bind(this));\n    }\n\n    function onDomReady() {\n        var components = $(\"*[data-song-vid]\");\n        if (components.length > 0) {\n            for (var i = 0; i < components.length; i++) {\n                this.players.push(new Tmt.Components.Player($(components.get(i))));\n            }\n            includeYoutubeScript.call(this);\n        }\n        this.emit('bound', this);\n    }\n\n    function onYouTubeReady() {\n        for (var i = 0; i < this.players.length; i++) {\n            this.players[i].render();\n        }\n    }\n\n    function includeYoutubeScript() {\n        var tag = document.createElement('script');\n        tag.src = \"//www.youtube.com/player_api\";\n\n        window.onYouTubeIframeAPIReady = onYouTubeReady.bind(this);\n\n        var firstScriptTag = document.getElementsByTagName('script')[0];\n        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);\n    }\n\n}(jQuery));\n","(function ($, undefined) {\n\n    \"use strict\";\n\n    /**\n     * Ajax-enabled forms public bootstraper\n     */\n    var UpvoteFormsInitializer = namespace(\"Tmt.Initializers\").UpvoteFormsInitializer = function () {\n        this.boxes = [];\n        this.initialize();\n    };\n\n    inherit([Tmt.EventEmitter], UpvoteFormsInitializer, {\n        'build': function (app) {\n            addEvents.call(this, app);\n        }\n    });\n\n    function addEvents(app) {\n        app.initializers.AjaxFormsInitializer.on('bound', bindToAjaxForms.bind(this));\n        app.profile.on('upvoteSet', updateStateFirstTime.bind(this));\n    }\n\n    function bindToAjaxForms(AjaxFormsInitializer) {\n        var upvoteForms = filter('[data-ctrl=\"upvote-widget\"]', AjaxFormsInitializer.forms);\n\n        for (var i = 0, len = upvoteForms.length; i < len; i++) {\n            this.boxes.push(new Tmt.Components.UpvoteForm(upvoteForms[i]));\n        }\n\n        this.emit('bound', this);\n    }\n\n    function updateStateFirstTime(type, newValues) {\n\n        for (var i = 0, len = this.boxes.length; i < len; i++) {\n            var box = this.boxes[i];\n\n            if (box.getType() == type) {\n                var matching = newValues[box.getObjectId()];\n                if (matching) {\n                    box.setValue(matching);\n                }\n\n                box.unlock();\n            }\n        }\n\n        this.emit(\"completed\");\n    }\n\n}(jQuery));\n"]}